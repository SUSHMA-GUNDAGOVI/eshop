{% extends "landing_base.html" %}

{% block title %}Shopping Cart - Your E-Shop{% endblock %}

{% block content %}

<style>
    .pro-qty-2 .qtybtn {
        width: 35px;
        cursor: pointer;
        float: left;
        font-size: 20px;
        line-height: 40px;
        text-align: center;
        transition: all 0.3s;
        user-select: none; 
    }

    .pro-qty-2 .qtybtn:hover {
        background: #f5f5f5;
    }

    .pro-qty-2 {
        width: 120px;
        height: 40px;
        padding: 0;
        display: inline-block;
        position: relative;
    }
    
    .pro-qty-2 input {
        width: 50px;
        float: left;
        border: none;
        height: 38px;
        text-align: center;
        font-size: 14px;
        font-weight: 600;
    }
</style>

<section class="breadcrumb-option">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb__text">
                    <h4>Shopping Cart</h4>
                    <div class="breadcrumb__links">
                        <a href="/">Home</a> 
                        <a href="{% url 'shop_all' %}">Shop</a> 
                        <span>Shopping Cart</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="shopping-cart spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <div class="shopping__cart__table">
                    <table>
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Total</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if cart_items %}
                                {% for item in cart_items %}
                                    <tr class="cart-row" data-item-id="{{ item.item_id }}" data-price="{{ item.price }}" data-discount-percent="{{ item.discount_percent }}">
                                        <td class="product__cart__item">
                                            <div class="product__cart__item__pic">
                                                {% if item.selected_image %}
                                                    <img src="{{ item.selected_image }}" alt="{{ item.product.title }}" style="max-width: 100px; border-radius: 8px;">
                                                {% else %}
                                                    <img src="{{ item.product.photo.url }}" alt="{{ item.product.title }}" style="max-width: 100px; border-radius: 8px;">
                                                {% endif %}
                                            </div>
                                            <div class="product__cart__item__text">
                                                <h6>{{ item.product.title }}</h6>
                                                <p class="mb-0 text-muted small">
                                                    {% if item.size != 'N/A' %}Size: {{ item.size }}{% endif %}
                                                    {% if item.size != 'N/A' and item.color != 'N/A' %} | {% endif %}
                                                    {% if item.color != 'N/A' %}Color: {{ item.color }}{% endif %}
                                                </p>
                                            </div>
                                        </td>
                                        
                                        <td class="cart__price">
                                            <!-- Original Price -->
                                            <div class="original-price">
                                                <del style="color:#888; font-size: 14px;">₹{{ item.price|floatformat:2 }}</del>
                                            </div>
                                            
                                            <!-- Discount Percentage -->
                                            {% if item.discount_percent > 0 %}
                                            <div class="discount-percent" style="color: #28a745; font-size: 13px; font-weight: 600;">
                                                {{ item.discount_percent|floatformat:0 }}% OFF
                                            </div>
                                            {% endif %}
                                            
                                            <!-- Discounted Price -->
                                            <div class="discounted-price" style="font-size: 16px; font-weight: 600; color: #333;">
                                                ₹{{ item.line_after_discount|floatformat:2 }}
                                            </div>
                                            
                                        </td>
                                        
                                        <td class="quantity__item">
                                            <div class="quantity">
                                                <div class="pro-qty-2">
                                                    <span class="dec qtybtn">&lt;</span>
                                                    <input type="text" value="{{ item.quantity }}" class="quantity-input" readonly>
                                                    <span class="inc qtybtn">&gt;</span>
                                                </div>
                                            </div>
                                        </td>
                                        
                                        <td class="cart__price">
                                            <div class="line-total">
                                                ₹<span class="item-line-total">{{ item.line_after_discount|floatformat:2 }}</span>
                                            </div>
                                            {% if item.line_discount > 0 %}
                                            <div class="line-savings" style="color: #28a745; font-size: 12px;">
                                                Saved: ₹{{ item.line_discount|floatformat:2 }}
                                            </div>
                                            {% endif %}
                                        </td>
                                        
                                        <td class="cart__close">
                                            <button type="button" class="remove-item-btn" data-item-id="{{ item.item_id }}" data-item-title="{{ item.product.title }}" style="background: none; border: none; cursor: pointer; color: #333;">
                                                <i class="fa fa-close"></i>
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center">Your cart is currently empty.</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                
                <div class="row">
                    <div class="col-lg-6 col-md-6 col-sm-6">
                        <div class="continue__btn">
                            <a href="{% url 'shop_all' %}">Continue Shopping</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="cart__discount p-3" style="background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
                    <h6 class="mb-3" style="font-weight: 600;">Discount Code</h6>

                    <!-- Coupon Apply Form -->
                    <form method="POST" action="{% url 'apply_coupon' %}" class="d-flex gap-2 align-items-center">
                        {% csrf_token %}
                        <select name="coupon_code" class="form-select" style="flex: 1; height: 40px; font-size: 14px;" required>
                            <option value="">Select a coupon</option>
                            {% for c in coupons %}
                                <option value="{{ c.code }}">{{ c.code }}</option>
                            {% empty %}
                                <option value="">No coupons available</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-dark px-3" style="height: 40px;">Apply</button>
                    </form>

                    <!-- Applied Coupon Box -->
                    {% if applied_coupon %}
                    <div class="mt-3 position-relative p-3" style="background: #e8f9f0; border: 1px solid #bde5c8; border-radius: 8px;">
                        <p class="mb-0" style="color: #28a745; font-weight: 600;">
                            ✅ Applied: <strong>{{ applied_coupon.code }}</strong>
                            ({{ applied_coupon.discount_value }}
                            {% if applied_coupon.discount_type == 'percent' %}%{% else %}₹{% endif %})
                        </p>

                        <!-- Remove Coupon (Cross Icon) -->
                        <form method="POST" action="{% url 'remove_coupon' %}" style="position: absolute; top: 8px; right: 10px;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm p-0" style="border: none; background: transparent; color: #dc3545; font-size: 18px; line-height: 1;">
                                &times;
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>

           <div class="cart__total">
    <h6>Cart total</h6>
    <ul>
        <!-- Subtotal (After product discounts) -->
        <li>Subtotal <span id="cart-subtotal">₹{{ cart_subtotal|floatformat:2 }}</span></li>

        <!-- Shipping -->
        <li>
            Shipping
            <span id="shipping-cost" data-shipping="{{ shipping_cost|floatformat:2 }}">
                {% if shipping_cost == 0 %}
                    Free
                {% else %}
                    ₹{{ shipping_cost|floatformat:2 }}
                {% endif %}
            </span>
        </li>
      <!-- In your template, replace this section: -->
{% if applied_coupon %}
<li style="color: #28a745;">
    Coupon Discount
    <span id="coupon-amount">-₹{{ discount_amount|floatformat:2 }}</span>
</li>
{% endif %}

        <!-- Final Total -->
        <li class="total">Total <span id="order-total">₹{{ order_total|floatformat:2 }}</span></li>
    </ul>
    <a href="{% url 'checkout' %}" class="primary-btn">Proceed to checkout</a>
</div>
            </div>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function() {
        // Show toast notification if item was removed
        const urlParams = new URLSearchParams(window.location.search);
        const removedItemTitle = urlParams.get('cart_removed');

        if (removedItemTitle) {
            Toastify({
                text: removedItemTitle + " removed from your cart.",
                duration: 3000,
                close: true,
                gravity: "top", 
                position: "right", 
                style: {
                    background: "linear-gradient(to right, #ff416c, #ff4b2b)",
                },
            }).showToast();
            history.replaceState(null, null, window.location.pathname);
        }
        
        // Handle remove item button click
        $(document).on('click', '.remove-item-btn', function(e) {
            e.preventDefault();
            var itemId = $(this).data('item-id');
            var itemTitle = $(this).data('item-title');
            var $row = $(this).closest('.cart-row');
            
            // Confirm before removing
            Swal.fire({
                title: 'Remove Item?',
                text: 'Are you sure you want to remove ' + itemTitle + ' from your cart?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, remove it!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    removeItemFromCart(itemId, itemTitle, $row);
                }
            });
        });
        
        // Handle increment button click
        $(document).on('click', '.inc', function(e) {
            e.preventDefault();
            var $row = $(this).closest('.cart-row');
            var $input = $row.find('.quantity-input');
            var currentQty = parseInt($input.val());
            var newQty = currentQty + 1;
            
            $input.val(newQty);
            updateRowTotal($row, newQty);
            updateCartTotals();
        });
        
        // Handle decrement button click
        $(document).on('click', '.dec', function(e) {
            e.preventDefault();
            var $row = $(this).closest('.cart-row');
            var $input = $row.find('.quantity-input');
            var currentQty = parseInt($input.val());
            
            if (currentQty > 1) {
                var newQty = currentQty - 1;
                $input.val(newQty);
                updateRowTotal($row, newQty);
                updateCartTotals();
            }
        });
    });
    
    // Remove item from cart via AJAX
    function removeItemFromCart(itemId, itemTitle, $row) {
        var formData = new FormData();
        formData.append('item_id', itemId);
        
        $.ajax({
            url: '{% url "remove_from_cart" %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            data: formData,
            processData: false,
            contentType: false,
            success: function(data) {
                if (data.status === 'success') {
                    // Remove the row with animation
                    $row.fadeOut(300, function() {
                        $(this).remove();
                        
                        // Check if cart is empty
                        if ($('.cart-row').length === 0) {
                            $('tbody').html('<tr><td colspan="5" class="text-center">Your cart is currently empty.</td></tr>');
                        }
                        
                        // Update totals
                        updateCartTotals();
                    });
                    
                    Toastify({
                        text: itemTitle + " was removed from your cart.",
                        duration: 3000,
                        close: true,
                        gravity: "top", 
                        position: "right", 
                        style: {
                            background: "linear-gradient(to right, #ff416c, #ff4b2b)",
                        },
                    }).showToast();
                } else {
                    Toastify({
                        text: "Error removing item from cart.",
                        duration: 3000,
                        close: true,
                        gravity: "top", 
                        position: "right", 
                        style: {
                            background: "linear-gradient(to right, #ff416c, #ff4b2b)",
                        },
                    }).showToast();
                }
            },
            error: function(xhr) {
                Toastify({
                    text: "Error removing item from cart.",
                    duration: 3000,
                    close: true,
                    gravity: "top", 
                    position: "right", 
                    style: {
                        background: "linear-gradient(to right, #ff416c, #ff4b2b)",
                    },
                }).showToast();
            }
        });
    }
    
    // Update the total for a specific row
    function updateRowTotal($row, quantity) {
        var price = parseFloat($row.data('price'));
        var discountPercent = parseFloat($row.data('discount-percent')) || 0;
        
        // Calculate line total
        var lineOriginal = price * quantity;
        var lineDiscount = discountPercent > 0 ? (lineOriginal * discountPercent / 100) : 0;
        var lineTotal = lineOriginal - lineDiscount;
        
        $row.find('.item-line-total').text(lineTotal.toFixed(2));
        
        // Update savings display if it exists
        var $savings = $row.find('.line-savings');
        if ($savings.length && lineDiscount > 0) {
            $savings.text('Saved: ₹' + lineDiscount.toFixed(2));
        }
    }
    
    // Recalculate cart subtotal, discounts, and final total
     function updateCartTotals() {
        let subtotal = 0;
        let quantityChanged = false;

        $('.cart-row').each(function() {
            let $row = $(this);
            let quantity = parseInt($row.find('.quantity-input').val()) || 0;
            let price = parseFloat($row.data('price')) || 0;
            let discountPercent = parseFloat($row.data('discount-percent')) || 0;

            // Calculate line total after discount
            let lineOriginal = price * quantity;
            let lineDiscount = discountPercent > 0 ? (lineOriginal * discountPercent / 100) : 0;
            let lineTotal = lineOriginal - lineDiscount;
            
            subtotal += lineTotal; // This is the discounted subtotal
        });

        // Shipping
        let shipping = parseFloat($('#shipping-cost').data('shipping')) || 0;

        // ✅ Get original coupon details
        let couponAmount = 0;
        let couponType = '';
        let couponValue = 0;
        
        {% if applied_coupon %}
            couponType = '{{ applied_coupon.discount_type }}';
            couponValue = parseFloat('{{ applied_coupon.discount_value }}') || 0;
            
            // ✅ Recalculate coupon discount based on NEW subtotal + shipping
            let orderTotal = subtotal + shipping;
            
            if (couponType === 'percent') {
                couponAmount = (orderTotal * couponValue / 100);
            } else {
                // Fixed amount
                couponAmount = Math.min(couponValue, orderTotal);
            }
            
            couponAmount = Math.max(0, couponAmount);
        {% endif %}

        // Compute final total (subtotal + shipping - coupon)
        let total = subtotal + shipping - couponAmount;

        // Ensure values are not negative
        total = Math.max(0, total);

        // Update DOM values
        $('#cart-subtotal').text('₹' + subtotal.toFixed(2));

        if (shipping === 0) {
            $('#shipping-cost').text('Free');
        } else {
            $('#shipping-cost').text('₹' + shipping.toFixed(2));
        }

        // Update coupon display if it exists
        if ($('#coupon-amount').length && couponAmount > 0) {
            $('#coupon-amount').text('-₹' + couponAmount.toFixed(2));
        }

        $('#order-total').text('₹' + total.toFixed(2));
    }
    
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

{% endblock %}