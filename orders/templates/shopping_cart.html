{% extends "landing_base.html" %}

{% block title %}Shopping Cart - Your E-Shop{% endblock %}

{% block content %}

<style>
    .pro-qty-2 .qtybtn {
    width: 35px;
    cursor: pointer;
    float: left;
    font-size: 20px;  /* slightly bigger */
    line-height: 40px;
    text-align: center;
    transition: all 0.3s;
    user-select: none; 
}

.pro-qty-2 .qtybtn:hover {
    background: #f5f5f5;
}
</style>
    <section class="breadcrumb-option">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="breadcrumb__text">
                        <h4>Shopping Cart</h4>
                        <div class="breadcrumb__links">
                            <a href="/">Home</a> 
                            <a href="">Shop</a> 
                            <span>Shopping Cart</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <section class="shopping-cart spad">
        <div class="container">
            <div class="row">
                <div class="col-lg-8">
                    <div class="shopping__cart__table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if cart_items %}
                                    {% for item in cart_items %}
                                        <tr class="cart-row" data-item-id="{{ item.id }}" data-price="{{ item.price }}">
                                            <td class="product__cart__item">
                                                <div class="product__cart__item__pic">
                                                    <img src="{{ item.product.photo.url }}" alt="{{ item.product.title }}" style="max-width: 100px;">
                                                </div>
                                                <div class="product__cart__item__text">
                                                    <h6>{{ item.product.title }}</h6>
                                                    <p>
                                                        {% if item.size != 'N/A' %}Size: {{ item.size }}{% endif %}
                                                        {% if item.size != 'N/A' and item.color != 'N/A' %} | {% endif %}
                                                        {% if item.color != 'N/A' %}Color: {{ item.color }}{% endif %}
                                                    </p>
                                                </div>
                                            </td>

                                            <td class="cart__price">₹<span class="item-price">{{ item.price|floatformat:2 }}</span></td>
                                            
                                           <td class="quantity__item">
    <div class="quantity">
        <div class="pro-qty-2">
            <span class="dec qtybtn">&lt;</span> <!-- Left: decrement -->
            <input type="text" value="{{ item.quantity }}" class="quantity-input" readonly>
            <span class="inc qtybtn">&gt;</span> <!-- Right: increment -->
        </div>
    </div>
</td>

                                            
                                            <td class="cart__price">₹<span class="item-line-total">{{ item.line_total|floatformat:2 }}</span></td>
                                            
                                            <td class="cart__close">
                                                <form action="{% url 'remove_from_cart' %}" method="POST" style="display: inline;">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="item_id" value="{{ item.id }}">
                                                    <button type="submit" style="background: none; border: none; cursor: pointer; color: #333;">
                                                        <i class="fa fa-close"></i>
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center">Your cart is currently empty.</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="row">
                        <div class="col-lg-6 col-md-6 col-sm-6">
                            <div class="continue__btn">
                                <a href="/">Continue Shopping</a>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6 col-sm-6">
                            <div class="continue__btn update__btn">
                                <a href="#" id="update-cart-btn"><i class="fa fa-spinner"></i> Update cart</a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <div class="cart__discount">
                        <h6>Discount codes</h6>
                        <form action="#">
                            {% csrf_token %}
                            <input type="text" placeholder="Coupon code">
                            <button type="submit">Apply</button>
                        </form>
                    </div>
                    <div class="cart__total">
                        <h6>Cart total</h6>
                        <ul>
                            <li>Subtotal <span id="cart-subtotal">₹{{ cart_subtotal|floatformat:2 }}</span></li>
                            <li>Shipping <span id="shipping-cost" data-shipping="{{ shipping_cost }}">₹{{ shipping_cost|floatformat:2 }}</span></li>
                            <li>Tax <span id="tax-amount">₹{{ tax_amount|floatformat:2 }}</span></li>
                            <li class="cart_total_final">Total <span id="order-total">₹{{ order_total|floatformat:2 }}</span></li>
                        </ul>
                        <a href="" class="primary-btn">Proceed to checkout</a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        $(document).ready(function() {
            // Show toast notification if item was removed
            const urlParams = new URLSearchParams(window.location.search);
            const removedItemTitle = urlParams.get('cart_removed');

            if (removedItemTitle) {
                Toastify({
                    text: removedItemTitle + " was removed from your cart.",
                    duration: 3000,
                    close: true,
                    gravity: "top", 
                    position: "right", 
                    style: {
                        background: "linear-gradient(to right, #ff416c, #ff4b2b)",
                    },
                }).showToast();
                history.replaceState(null, null, window.location.pathname);
            }
            
            // Handle increment button click
            $(document).on('click', '.inc', function(e) {
                e.preventDefault();
                var $row = $(this).closest('.cart-row');
                var $input = $row.find('.quantity-input');
                var currentQty = parseInt($input.val());
                var newQty = currentQty + 1;
                
                $input.val(newQty);
                updateRowTotal($row, newQty);
                updateCartTotals();
            });
            
            // Handle decrement button click
            $(document).on('click', '.dec', function(e) {
                e.preventDefault();
                var $row = $(this).closest('.cart-row');
                var $input = $row.find('.quantity-input');
                var currentQty = parseInt($input.val());
                
                if (currentQty > 1) {
                    var newQty = currentQty - 1;
                    $input.val(newQty);
                    updateRowTotal($row, newQty);
                    updateCartTotals();
                }
            });
            
            // Update cart button
            $('#update-cart-btn').on('click', function(e) {
                e.preventDefault();
                updateCartOnServer();
            });
        });
        
        // Update the total for a specific row
        function updateRowTotal($row, quantity) {
            var price = parseFloat($row.data('price'));
            var lineTotal = price * quantity;
            
            // Update ONLY this row's total
            $row.find('.item-line-total').text(lineTotal.toFixed(2));
        }
        
        // Recalculate cart subtotal, tax, and final total
        function updateCartTotals() {
            var subtotal = 0;
            
            // Loop through each row and sum up the line totals
            $('.cart-row').each(function() {
                var $row = $(this);
                var quantity = parseInt($row.find('.quantity-input').val());
                var price = parseFloat($row.data('price'));
                subtotal += (quantity * price);
            });
            
            // Get shipping
            var shipping = parseFloat($('#shipping-cost').data('shipping'));
            
            // Calculate tax (5%)
            var tax = subtotal * 0.05;
            
            // Calculate total
            var total = subtotal + shipping + tax;
            
            // Update displays
            $('#cart-subtotal').text('₹' + subtotal.toFixed(2));
            $('#tax-amount').text('₹' + tax.toFixed(2));
            $('#order-total').text('₹' + total.toFixed(2));
        }
        
        // Send updated quantities to server
        function updateCartOnServer() {
            var cartData = [];
            
            $('.cart-row').each(function() {
                var itemId = $(this).data('item-id');
                var quantity = parseInt($(this).find('.quantity-input').val());
                
                cartData.push({
                    cart_id: itemId,
                    quantity: quantity
                });
            });
            
            $.ajax({
                url: '/update-cart/',
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                contentType: 'application/json',
                data: JSON.stringify({ cart_items: cartData }),
                success: function(data) {
                    if (data.status === 'success') {
                        Toastify({
                            text: "Cart updated successfully!",
                            duration: 3000,
                            close: true,
                            gravity: "top", 
                            position: "right", 
                            style: {
                                background: "linear-gradient(to right, #00b09b, #96c93d)",
                            },
                        }).showToast();
                        
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    }
                },
                error: function(xhr) {
                    Toastify({
                        text: "Error updating cart.",
                        duration: 3000,
                        close: true,
                        gravity: "top", 
                        position: "right", 
                        style: {
                            background: "linear-gradient(to right, #ff416c, #ff4b2b)",
                        },
                    }).showToast();
                }
            });
        }
        
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
    
    <style>
        .pro-qty-2 {
            width: 120px;
            height: 40px;
            padding: 0;
            display: inline-block;
            position: relative;
        }
        
        .pro-qty-2 .qtybtn {
            width: 35px;
            cursor: pointer;
            float: left;
            font-size: 18px;
            line-height: 40px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .pro-qty-2 .qtybtn:hover {
            background: #f5f5f5;
        }
        
        .pro-qty-2 input {
            width: 50px;
            float: left;
            border: none;
            height: 38px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
        }
    </style>
{% endblock %}