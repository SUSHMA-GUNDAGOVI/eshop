{% extends 'landing_base.html' %}
{% load static %}

{% block title %}My Account{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

<style>
.account-dashboard {
    max-width: 1200px;
    margin: 50px auto;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.08);
    display: flex;
    overflow: hidden;
    font-family: 'Poppins', sans-serif;
}

/* Sidebar */
.account-sidebar {
    width: 280px;
    background: #f8f9fa;
    border-right: 1px solid #eee;
    padding: 30px 20px;
}
.account-sidebar .profile-info {
    text-align: center;
    margin-bottom: 30px;
}
.account-sidebar img {
    width: 100px; height: 100px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #fff;
    box-shadow: 0 0 6px rgba(0,0,0,0.1);
    margin-bottom: 10px;
}
.account-sidebar h5 { font-weight: 600; font-size: 16px; color: #333; }
.account-sidebar p { font-size: 13px; color: #888; margin-bottom: 0; }
.account-sidebar ul { list-style: none; padding: 0; margin-top: 30px; }
.account-sidebar ul li { margin-bottom: 10px; }
.account-sidebar ul li a {
    display: flex; align-items: center;
    padding: 10px 15px;
    color: #333; font-weight: 500;
    border-radius: 8px; transition: all 0.3s ease;
}
.account-sidebar ul li a:hover,
.account-sidebar ul li a.active {
    background: #8e8989; color: #fff;
}
.account-sidebar ul li a i { font-size: 18px; margin-right: 10px; }

/* Main Content */
.account-content { flex: 1; padding: 40px; }
.account-content h4 {
    font-size: 22px; font-weight: 600;
    margin-bottom: 25px; color: #333;
    border-bottom: 2px solid #f2f2f2;
    padding-bottom: 10px;
}

/* Profile Info */
.profile-details { display: flex; flex-wrap: wrap; gap: 30px; }
.profile-card {
    flex: 1; background: #fafafa;
    border-radius: 8px; padding: 20px;
    border: 1px solid #eee;
}
.profile-card h6 { font-size: 14px; color: #888; margin-bottom: 5px; text-transform: uppercase; }
.profile-card p { font-size: 16px; color: #333; font-weight: 500; }

.edit-btn, .cancel-btn {
    display: inline-block;
    background-color: #8e8989; color: #fff;
    padding: 10px 20px; border-radius: 6px;
    margin-top: 20px; text-decoration: none;
    transition: 0.3s; cursor: pointer;
}
.cancel-btn { background-color: #6c757d; }
.edit-btn:hover { background-color: #6b6464; }
.cancel-btn:hover { background-color: #5a6268; }

/* Inline Edit Form */
#edit-form {
    display: none;
    margin-top: 25px;
    background: #fafafa;
    padding: 25px;
    border-radius: 8px;
    border: 1px solid #eee;
}
#edit-form input, #edit-form textarea {
    width: 100%; padding: 10px;
    border: 1px solid #ddd; border-radius: 6px;
    margin-bottom: 15px;
}
#edit-form button {
    background-color: #8e8989; color: #fff;
    border: none; padding: 10px 20px;
    border-radius: 6px; cursor: pointer;
}
#edit-form button:hover { background-color: #6b6464; }

/* Responsive */
@media (max-width: 992px) {
    .account-dashboard { flex-direction: column; }
    .account-sidebar { width: 100%; border-bottom: 1px solid #eee; border-right: none; }
}
</style>

<div class="account-dashboard">
    <!-- Sidebar -->
    <div class="account-sidebar">
        <div class="profile-info">
            {% if user.profile_image %}
                <img src="{{ user.profile_image.url }}" alt="Profile Image">
            {% else %}
                <img src="{% static 'frontend/img/profile.png' %}" alt="Profile Image">
            {% endif %}
            <h5>{{ user.first_name }} {{ user.last_name }}</h5>
            <p>{{ user.email }}</p>
        </div>
        <ul>
            <li><a href="#" class="active"><i class="fa-solid fa-user"></i> My Profile</a></li>
            <li><a href="#"><i class="fa-solid fa-box"></i> My Orders</a></li>
            <li><a href="{% url 'wishlist' %}"><i class="fa-solid fa-heart"></i> Wishlist</a></li>
            <li><a href="{% url 'account_address' %}"><i class="fa-solid fa-location-dot"></i> Saved Address</a></li>
            <li><a href="{% url 'logout' %}"><i class="fa-solid fa-right-from-bracket"></i> Logout</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="account-content">
        <h4>My Profile</h4>

        <!-- Profile Display -->
        <div class="profile-details" id="profile-view">
            <div class="profile-card">
                <h6>Full Name</h6>
                <p>{{ user.first_name }} {{ user.last_name }}</p>
            </div>
            <div class="profile-card">
                <h6>Email</h6>
                <p>{{ user.email }}</p>
            </div>
            <div class="profile-card">
                <h6>Phone</h6>
                <p>{{ user.phone|default:"Not Added" }}</p>
            </div>
            <div class="profile-card">
                <h6>Address</h6>
                <p>{{ user.address|default:"Not Added" }}</p>
            </div>
        </div>

        <!-- Edit Button -->
        <a class="edit-btn" id="editProfileBtn" style="color:white">Edit Profile</a>

        <!-- Inline Edit Form -->
        <form id="edit-form" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-6">
                    <label>First Name</label>
                    <input type="text" name="first_name" value="{{ user.first_name }}" required>
                </div>
                <div class="col-md-6">
                    <label>Last Name</label>
                    <input type="text" name="last_name" value="{{ user.last_name }}" required>
                </div>
                <div class="col-md-6">
                    <label>Email</label>
                    <input type="email" name="email" value="{{ user.email }}" readonly>
                </div>
                <div class="col-md-6">
                    <label>Phone</label>
                    <input type="text" name="phone" value="{{ user.phone }}">
                </div>
                <div class="col-12">
                    <label>Address</label>
                    <textarea name="address" rows="3">{{ user.address }}</textarea>
                </div>
                <div class="col-12">
                    <label>Profile Image</label>
                    <input type="file" name="profile_image">
                </div>
            </div>
            <button type="submit">Save Changes</button>
            <a class="cancel-btn" id="cancelEdit">Cancel</a>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script>
// CSRF Helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('edit-form');
    const csrftoken = getCookie('csrftoken');

    // Toggle Edit Form
    document.getElementById("editProfileBtn").addEventListener("click", function() {
        document.getElementById("profile-view").style.display = "none";
        form.style.display = "block";
        this.style.display = "none";
    });

    document.getElementById("cancelEdit").addEventListener("click", function(e) {
        e.preventDefault();
        form.style.display = "none";
        document.getElementById("profile-view").style.display = "flex";
        document.getElementById("editProfileBtn").style.display = "inline-block";
    });

    // AJAX Form Submit
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(form);

        fetch("{% url 'orders_edit_profile' %}", {
            method: "POST",
            headers: {
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === "success"){
                Toastify({
                    text: data.message,
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "#28a745",
                }).showToast();
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(error => console.error('Error:', error));
    });
});
</script>
{% endblock %}
