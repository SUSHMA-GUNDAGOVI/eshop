{% extends 'admin_base.html' %}

{% block title %}Add New Product{% endblock %}

{% block content %}
<style>
.color-selection-grid {
    border: 1px solid #e3e6f0;
    border-radius: 8px;
    padding: 15px;
    background: #f8f9fc;
}

.color-option {
    cursor: pointer;
    transition: all 0.3s ease;
}

.color-option:hover {
    transform: translateY(-2px);
}

.color-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    padding: 10px 5px;
    border-radius: 8px;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.color-label:hover {
    background: rgba(0,0,0,0.05);
}

.color-checkbox:checked + .color-label {
    border-color: #4e73df;
    background: rgba(78, 115, 223, 0.1);
}

.color-swatch {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin-bottom: 8px;
    border: 2px solid transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.color-checkbox:checked + .color-label .color-swatch {
    border-color: #333;
    transform: scale(1.1);
}

.add-color-swatch {
    background: #f8f9fc;
    border: 2px dashed #dee2e6;
    color: #6c757d;
    font-size: 1.2rem;
}

.add-color-option:hover .add-color-swatch {
    background: #e9ecef;
    border-color: #4e73df;
    color: #4e73df;
}

.color-name {
    font-size: 0.8rem;
    text-align: center;
    font-weight: 500;
    color: #5a5c69;
}

.selected-color-badge {
    border-radius: 20px;
    padding: 8px 12px;
    font-size: 0.8rem;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    min-width: 80px;
    justify-content: space-between;
    margin: 5px;
}

.remove-color-btn {
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    padding: 0;
    margin-left: 5px;
    opacity: 0.7;
}

.remove-color-btn:hover {
    opacity: 1;
}

.form-control-color {
    height: 50px;
    width: 100%;
}
</style>

<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h1 class="h3 text-gray-800">Product Management</h1>
    </div>

    <!-- Add Product Form -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Add Product</h6>
        </div>
        <div class="card-body">
            {% if error_message %}
            <div class="alert alert-danger">{{ error_message }}</div>
            {% endif %}
            {% if success_message %}
            <div class="alert alert-success">{{ success_message }}</div>
            {% endif %}

            <form method="post" enctype="multipart/form-data" id="productForm">
                {% csrf_token %}

                <div class="form-group">
                    <label for="inputTitle">Title <span class="text-danger">*</span></label>
                    <input id="inputTitle" type="text" name="title" placeholder="Enter title"
                        value="{{ request.POST.title }}" class="form-control">
                </div>

                <!-- Summary -->
                <div class="form-group">
                    <label for="summary">Summary <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="summary" name="summary">{{ request.POST.summary }}</textarea>
                </div>

                <!-- Description -->
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea class="form-control" id="description"
                        name="description">{{ request.POST.description }}</textarea>
                </div>

                <!-- Featured -->
                <div class="form-group">
                    <label for="is_featured">Is Featured</label><br>
                    <input type="checkbox" name="is_featured" id="is_featured" value="1" {% if request.POST.is_featured %}checked{% endif %}> Yes
                </div>

                <!-- Category -->
                <div class="form-group">
                    <label for="cat_id">Category <span class="text-danger">*</span></label>
                    <select name="cat_id" id="cat_id" class="form-control">
                        <option value="">--Select any category--</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}">{{ cat.title }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Sub Category -->
                <div class="form-group d-none" id="child_cat_div">
                    <label for="child_cat_id">Sub Category</label>
                    <select name="child_cat_id" id="child_cat_id" class="form-control">
                        <option value="">--Select any sub category--</option>
                    </select>
                </div>

                <!-- Price -->
                <div class="form-group">
                    <label for="price">Price (â‚¹) <span class="text-danger">*</span></label>
                    <input id="price" type="number" name="price" placeholder="Enter price"
                        value="{{ request.POST.price }}" class="form-control">
                </div>

                <!-- Discount -->
                <div class="form-group">
                    <label for="discount">Discount (%)</label>
                    <input id="discount" type="number" name="discount" min="0" max="100" placeholder="Enter discount"
                        value="{{ request.POST.discount }}" class="form-control">
                </div>

                <!-- Size -->
                <div class="form-group">
                    <label for="size">Size <span class="text-danger">*</span></label>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="size" value="S" id="size_s">
                                <label class="form-check-label" for="size_s">Small (S)</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="size" value="M" id="size_m">
                                <label class="form-check-label" for="size_m">Medium (M)</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="size" value="L" id="size_l">
                                <label class="form-check-label" for="size_l">Large (L)</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="size" value="XL" id="size_xl">
                                <label class="form-check-label" for="size_xl">Extra Large (XL)</label>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="size" value="XXL" id="size_xxl">
                                <label class="form-check-label" for="size_xxl">XXL</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="size" value="XXXL" id="size_xxxl">
                                <label class="form-check-label" for="size_xxxl">XXXL</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Color - Multiple Selection -->
                <div class="form-group">
                    <label for="color">Color <span class="text-danger">*</span></label>
                    
                    <!-- Color Selection Grid -->
                    <div class="color-selection-grid mb-3">
                        <div class="row" id="colorGrid">
                            <!-- Black -->
                            <div class="col-md-2 col-4 mb-2">
                                <div class="color-option" data-color="Black" data-hex="#000000">
                                    <input type="checkbox" class="color-checkbox" name="color" value="Black" id="color_black" hidden>
                                    <label for="color_black" class="color-label">
                                        <span class="color-swatch" style="background-color: #000000;"></span>
                                        <span class="color-name">Black</span>
                                    </label>
                                </div>
                            </div>
                            <!-- White -->
                            <div class="col-md-2 col-4 mb-2">
                                <div class="color-option" data-color="White" data-hex="#ffffff">
                                    <input type="checkbox" class="color-checkbox" name="color" value="White" id="color_white" hidden>
                                    <label for="color_white" class="color-label">
                                        <span class="color-swatch" style="background-color: #ffffff; border: 1px solid #ddd;"></span>
                                        <span class="color-name">White</span>
                                    </label>
                                </div>
                            </div>
                            <!-- Navy Blue -->
                            <div class="col-md-2 col-4 mb-2">
                                <div class="color-option" data-color="Navy Blue" data-hex="#000080">
                                    <input type="checkbox" class="color-checkbox" name="color" value="Navy Blue" id="color_navy" hidden>
                                    <label for="color_navy" class="color-label">
                                        <span class="color-swatch" style="background-color: #000080;"></span>
                                        <span class="color-name">Navy Blue</span>
                                    </label>
                                </div>
                            </div>
                            <!-- Cream -->
                            <div class="col-md-2 col-4 mb-2">
                                <div class="color-option" data-color="Cream" data-hex="#fffdd0">
                                    <input type="checkbox" class="color-checkbox" name="color" value="Cream" id="color_cream" hidden>
                                    <label for="color_cream" class="color-label">
                                        <span class="color-swatch" style="background-color: #fffdd0; border: 1px solid #ddd;"></span>
                                        <span class="color-name">Cream</span>
                                    </label>
                                </div>
                            </div>
                            <!-- Add Custom Color Button -->
                            <div class="col-md-2 col-4 mb-2">
                                <div class="color-option add-color-option" onclick="openColorModal()">
                                    <div class="color-label text-center">
                                        <span class="color-swatch add-color-swatch">
                                            <i class="fas fa-plus"></i>
                                        </span>
                                        <span class="color-name">Add Color</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Selected Colors Display -->
                    <div class="selected-colors-container mb-3">
                        <label>Selected Colors:</label>
                        <div id="selectedColors" class="d-flex flex-wrap gap-2 mt-2">
                            <span class="text-muted">No colors selected</span>
                        </div>
                    </div>

                    <!-- Color-Specific Media Uploads -->
<div id="colorMediaContainer" class="mt-3">
    <!-- Color-specific file upload areas will appear here -->
</div>
                </div>

                <!-- Hidden Color Inputs -->
                <div id="hiddenColorInputs"></div>

                <!-- Brand -->
                <div class="form-group">
                    <label for="brand_id">Brand</label>
                    <select name="brand_id" class="form-control">
                        <option value="">--Select Brand--</option>
                        {% for brand in brands %}
                        <option value="{{ brand.id }}">{{ brand.title }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Condition -->
                <div class="form-group">
                    <label for="condition">Condition</label>
                    <select name="condition" class="form-control">
                        <option value="">--Select Condition--</option>
                        <option value="default">Default</option>
                        <option value="new">New</option>
                        <option value="hot">Hot</option>
                    </select>
                </div>

                <!-- Quantity -->
                <div class="form-group">
                    <label for="stock">Quantity <span class="text-danger">*</span></label>
                    <input id="quantity" type="number" name="stock" min="0" placeholder="Enter quantity"
                        value="{{ request.POST.stock }}" class="form-control">
                </div>
<div class="form-group">
    <label for="shipping_option">Shipping Option</label>
    <select id="shipping_option" name="shipping_option" class="form-control" onchange="toggleShippingInput(this.value)">
        <option value="free" selected>Free Shipping</option>
        <option value="custom">Custom Shipping Charge</option>
    </select>
</div>

<div class="form-group" id="shipping_charge_group" style="display: none;">
    <label for="shipping_charge">Shipping Charge (â‚¹)</label>
    <input id="shipping_charge" type="number" name="shipping_charge" step="0.01" min="0"
        placeholder="Enter shipping charge (e.g. 50)" class="form-control">
</div>

               

                <!-- Submit Buttons -->
                <button type="submit" class="btn btn-success mt-3">ðŸ’¾ Save Product</button>
                <a href="{% url 'product_list' %}" class="btn btn-secondary mt-3">Cancel</a>
            </form>
        </div>
    </div>
</div>

<!-- Custom Color Modal -->
<div class="modal fade" id="colorModal" tabindex="-1" aria-labelledby="colorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="colorModalLabel">Add Custom Color</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="customColorName" class="form-label">Color Name</label>
                    <input type="text" class="form-control" id="customColorName" placeholder="e.g., Burgundy" maxlength="50">
                </div>
                <div class="mb-3">
                    <label for="customColorPicker" class="form-label">Select Color</label>
                    <input type="color" class="form-control form-control-color" id="customColorPicker" value="#ff0000">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addCustomColor()">
                    <i class="fas fa-plus"></i> Add
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// Store for color mapping (name -> hex)
const colorMap = {
    'Black': '#000000',
    'White': '#ffffff',
    'Navy Blue': '#000080',
    'Cream': '#fffdd0'
};

// Initialize on page load
$(document).ready(function() {
    console.log('Document ready - initializing color selector');
    
    // Update display on load
    updateSelectedColorsDisplay();
    
    // Handle color selection - Use event delegation
    $(document).on('click', '.color-option:not(.add-color-option)', function(e) {
        e.preventDefault();
        const checkbox = $(this).find('.color-checkbox');
        checkbox.prop('checked', !checkbox.prop('checked'));
        updateSelectedColorsDisplay();
    });
    
    // File preview handler
    $('#media_files').on('change', function() {
        const files = this.files;
        const preview = $('#filePreview');
        
        if (files.length > 0) {
            let html = '<ul class="list-unstyled mb-0">';
            for (let i = 0; i < files.length; i++) {
                html += '<li><i class="fas fa-file"></i> ' + files[i].name + '</li>';
            }
            html += '</ul>';
            preview.html(html);
        } else {
            preview.html('<span class="text-muted">No files selected</span>');
        }
    });
});

// Function to open modal
function openColorModal() {
    console.log('Opening color modal');
    // Reset form
    $('#customColorName').val('');
    $('#customColorPicker').val('#ff0000');
    
    // Show modal using Bootstrap 5
    const modalElement = document.getElementById('colorModal');
    const colorModal = new bootstrap.Modal(modalElement);
    colorModal.show();
}

// Function to add custom color
function addCustomColor() {
    const colorName = $('#customColorName').val().trim();
    const colorHex = $('#customColorPicker').val();

    if (!colorName) {
        alert('Please enter a color name');
        return;
    }

    // Check if color name already exists
    if (colorMap[colorName]) {
        alert('Color name already exists! Please use a different name.');
        return;
    }

    // Add to color map
    colorMap[colorName] = colorHex;
    
    // Create new color option
    createColorOption(colorName, colorHex);
    
    // Close modal
    const modalElement = document.getElementById('colorModal');
    const colorModal = bootstrap.Modal.getInstance(modalElement);
    colorModal.hide();
    
    showTempMessage('Color "' + colorName + '" added successfully!', 'success');
}

// Create new color option element
function createColorOption(colorName, colorHex) {
    const colorId = 'color_' + colorName.replace(/\s+/g, '_').toLowerCase();
    const borderStyle = (colorHex === '#ffffff' || colorHex === '#fffdd0') ? 'border: 1px solid #ddd;' : '';
    
    const colorOption = '<div class="col-md-2 col-4 mb-2">' +
        '<div class="color-option" data-color="' + colorName + '" data-hex="' + colorHex + '">' +
            '<input type="checkbox" class="color-checkbox" name="color" value="' + colorName + '" id="' + colorId + '" hidden>' +
            '<label for="' + colorId + '" class="color-label">' +
                '<span class="color-swatch" style="background-color: ' + colorHex + '; ' + borderStyle + '"></span>' +
                '<span class="color-name">' + colorName + '</span>' +
            '</label>' +
        '</div>' +
    '</div>';
    
    // Add before the "Add Color" button
    $('.add-color-option').parent().before(colorOption);
}

// Remove color from selection
function removeColor(colorName) {
    $('.color-checkbox[value="' + colorName + '"]').prop('checked', false);
    updateSelectedColorsDisplay();
    showTempMessage('Color "' + colorName + '" removed!', 'warning');
}

// Update the selected colors display
function updateSelectedColorsDisplay() {
    const displayContainer = $('#selectedColors');
    const colorMediaContainer = $('#colorMediaContainer');
    displayContainer.empty();
    colorMediaContainer.empty();
    
    const checkedColors = $('.color-checkbox:checked');
    
    if (checkedColors.length === 0) {
        displayContainer.html('<span class="text-muted">No colors selected</span>');
        return;
    }

    checkedColors.each(function() {
        const colorName = $(this).val();
        const colorHex = colorMap[colorName] || '#cccccc';
        const textColor = getTextColor(colorHex);
        
        // Selected color badge
        const colorBadge = `
            <div class="selected-color-badge" style="background-color:${colorHex}; color:${textColor}">
                ${colorName}
                <button type="button" class="remove-color-btn" onclick="removeColor('${colorName}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>`;
        displayContainer.append(colorBadge);

        // Create upload input for that color
        const colorUploadBlock = `
            <div class="form-group border rounded p-3 mb-3">
                <label><strong>${colorName}</strong> - Upload Images/Videos</label>
                <input type="file" name="media_files_${colorName}" multiple accept="image/*,video/*" class="form-control color-media-input" data-color="${colorName}">
                <div class="preview mt-2 text-muted small">No files selected</div>
            </div>`;
        colorMediaContainer.append(colorUploadBlock);
    });

    // Bind change event for new inputs
    $('.color-media-input').off('change').on('change', function() {
        const previewDiv = $(this).siblings('.preview');
        const files = this.files;
        if (files.length > 0) {
            let list = '<ul class="list-unstyled mb-0">';
            for (let i = 0; i < files.length; i++) {
                list += `<li><i class="fas fa-file"></i> ${files[i].name}</li>`;
            }
            list += '</ul>';
            previewDiv.html(list);
        } else {
            previewDiv.html('No files selected');
        }
    });
}

// Calculate text color based on background
function getTextColor(backgroundColor) {
    const hex = backgroundColor.replace('#', '');
    const r = parseInt(hex.substr(0, 2), 16);
    const g = parseInt(hex.substr(2, 2), 16);
    const b = parseInt(hex.substr(4, 2), 16);
    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
    return luminance > 0.5 ? '#000000' : '#ffffff';
}

// Show temporary message
function showTempMessage(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-warning';
    const alertDiv = $('<div class="alert ' + alertClass + ' alert-dismissible fade show mt-2">' +
        message +
        '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
    '</div>');
    
    $('.selected-colors-container').append(alertDiv);
    
    setTimeout(function() {
        alertDiv.remove();
    }, 3000);
}

// Prepare color inputs for form submission
function prepareColorInputs() {
    const hiddenContainer = $('#hiddenColorInputs');
    hiddenContainer.empty();
    
    // Get all checked colors
    $('.color-checkbox:checked').each(function() {
        const colorName = $(this).val();
        const colorHex = colorMap[colorName] || '#cccccc';
        
        // Create hidden inputs for each selected color
        const nameInput = '<input type="hidden" name="color_name" value="' + colorName + '">';
        const codeInput = '<input type="hidden" name="color_code" value="' + colorHex + '">';
        
        hiddenContainer.append(nameInput);
        hiddenContainer.append(codeInput);
    });
}

// Form submission handler
$('#productForm').on('submit', function(e) {
    // Prepare color inputs
    prepareColorInputs();
    
    // Validate at least one color is selected
    const selectedColors = $('.color-checkbox:checked').length;
    if (selectedColors === 0) {
        e.preventDefault();
        alert('Please select at least one color');
        return false;
    }
    
    return true;
});
</script>
<script>
function toggleShippingInput(option) {
    const chargeGroup = document.getElementById('shipping_charge_group');
    const chargeInput = document.getElementById('shipping_charge');

    if (option === 'custom') {
        chargeGroup.style.display = 'block';
        chargeInput.required = true;
    } else {
        chargeGroup.style.display = 'none';
        chargeInput.required = false;
        chargeInput.value = '';
    }
}

// Preserve visibility on page load
document.addEventListener('DOMContentLoaded', () => {
    toggleShippingInput(document.getElementById('shipping_option').value);
});
</script>
{% endblock %}