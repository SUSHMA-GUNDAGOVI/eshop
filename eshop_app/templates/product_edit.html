{% extends 'admin_base.html' %}

{% block title %}Edit Product: {{ product.title }}{% endblock %}

{% block content %}
<style>
/* Your existing CSS styles here */
.color-selection-grid {
    border: 1px solid #e3e6f0;
    border-radius: 8px;
    padding: 15px;
    background: #f8f9fc;
}

.color-option {
    cursor: pointer;
    transition: all 0.3s ease;
}

.color-option:hover {
    transform: translateY(-2px);
}

.color-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    padding: 10px 5px;
    border-radius: 8px;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.color-label:hover {
    background: rgba(0,0,0,0.05);
}

.color-checkbox:checked + .color-label {
    border-color: #4e73df;
    background: rgba(78, 115, 223, 0.1);
}

.color-swatch {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin-bottom: 8px;
    border: 2px solid transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.color-checkbox:checked + .color-label .color-swatch {
    border-color: #333;
    transform: scale(1.1);
}

.add-color-swatch {
    background: #f8f9fc;
    border: 2px dashed #dee2e6;
    color: #6c757d;
    font-size: 1.2rem;
}

.add-color-option:hover .add-color-swatch {
    background: #e9ecef;
    border-color: #4e73df;
    color: #4e73df;
}

.color-name {
    font-size: 0.8rem;
    text-align: center;
    font-weight: 500;
    color: #5a5c69;
}

.selected-color-badge {
    border-radius: 20px;
    padding: 8px 12px;
    font-size: 0.8rem;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    min-width: 80px;
    justify-content: space-between;
}

.remove-color-btn {
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    padding: 0;
    margin-left: 5px;
    opacity: 0.7;
}

.remove-color-btn:hover {
    opacity: 1;
}

.form-control-color {
    height: 50px;
    width: 100%;
}
</style>
<div class="container-fluid">

    <div class="d-flex align-items-center justify-content-between mb-3">
        <h1 class="h3 text-gray-800">Product Management</h1>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Edit Product: {{ product.title }}</h6>
        </div>
        <div class="card-body">
            {% if error_message %}
            <div class="alert alert-danger">{{ error_message }}</div>
            {% endif %}

            <form method="post" enctype="multipart/form-data" action="{% url 'product_edit' product.id %}">
                {% csrf_token %}

                <!-- Your existing form fields (title, summary, description, etc.) -->
                <div class="form-group">
                    <label for="inputTitle">Title <span class="text-danger">*</span></label>
                    <input id="inputTitle" type="text" name="title" placeholder="Enter title"
                        value="{% if request.POST.title %}{{ request.POST.title }}{% else %}{{ product.title }}{% endif %}" 
                        class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="summary">Summary <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="summary" name="summary" required>{% if request.POST.summary %}{{ request.POST.summary }}{% else %}{{ product.summary }}{% endif %}</textarea>
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea class="form-control" id="description" name="description">{% if request.POST.description %}{{ request.POST.description }}{% else %}{{ product.description }}{% endif %}</textarea>
                </div>

                <div class="form-group">
                    <label for="is_featured">Is Featured</label><br>
                    <input type="checkbox" name="is_featured" id="is_featured" value="1" 
                           {% if request.POST.is_featured or product.is_featured %}checked{% endif %}> Yes
                </div>

                <div class="form-group">
                    <label for="cat_id">Category <span class="text-danger">*</span></label>
                    <select name="cat_id" id="cat_id" class="form-control" required>
                        <option value="">--Select any category--</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}" 
                            {% if product.category.id == cat.id %}selected{% endif %}>{{ cat.title }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group {% if not product.child_category %}d-none{% endif %}" id="child_cat_div">
                    <label for="child_cat_id">Sub Category</label>
                    <select name="child_cat_id" id="child_cat_id" class="form-control">
                        {% if product.child_category %}
                            <option value="{{ product.child_category.id }}" selected>{{ product.child_category.title }}</option>
                        {% endif %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="price">Price (₹) <span class="text-danger">*</span></label>
                    <input id="price" type="number" name="price" placeholder="Enter price"
                        value="{% if request.POST.price %}{{ request.POST.price }}{% else %}{{ product.price|default_if_none:'' }}{% endif %}" 
                        class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="discount">Discount (%)</label>
                    <input id="discount" type="number" name="discount" min="0" max="100" placeholder="Enter discount"
                        value="{% if request.POST.discount %}{{ request.POST.discount }}{% else %}{{ product.discount|default:0 }}{% endif %}" 
                        class="form-control">
                </div>

                <!-- Size Section - Fixed to show existing values -->
                <div class="form-group">
                    <label for="size">Size <span class="text-danger">*</span></label>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="size" value="S" id="size_s"
                                    {% if 'S' in product.size %}checked{% endif %}>
                                <label class="form-check-label" for="size_s">
                                    Small (S)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="size" value="M" id="size_m"
                                    {% if 'M' in product.size %}checked{% endif %}>
                                <label class="form-check-label" for="size_m">
                                    Medium (M)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="size" value="L" id="size_l"
                                    {% if 'L' in product.size %}checked{% endif %}>
                                <label class="form-check-label" for="size_l">
                                    Large (L)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="size" value="XL" id="size_xl"
                                    {% if 'XL' in product.size %}checked{% endif %}>
                                <label class="form-check-label" for="size_xl">
                                    Extra Large (XL)
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="size" value="XXL" id="size_xxl"
                                    {% if 'XXL' in product.size %}checked{% endif %}>
                                <label class="form-check-label" for="size_xxl">
                                    XXL
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="size" value="XXXL" id="size_xxxl"
                                    {% if 'XXXL' in product.size %}checked{% endif %}>
                                <label class="form-check-label" for="size_xxxl">
                                    XXXL
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Color Section - Fixed to show existing values -->
                <div class="form-group">
                    <label for="color">Color <span class="text-danger">*</span></label>
                    
                    <!-- Color Selection Grid -->
                    <div class="color-selection-grid mb-3">
                        <div class="row">
                            <!-- Black -->
                            <div class="col-md-2 col-4 mb-2">
                                <div class="color-option" data-color="Black" data-hex="#000000">
                                    <input type="checkbox" class="color-checkbox" name="color" value="Black" id="color_black" hidden
                                        {% if 'Black' in product.color %}checked{% endif %}>
                                    <label for="color_black" class="color-label">
                                        <span class="color-swatch" style="background-color: #000000;"></span>
                                        <span class="color-name">Black</span>
                                    </label>
                                </div>
                            </div>
                            <!-- White -->
                            <div class="col-md-2 col-4 mb-2">
                                <div class="color-option" data-color="White" data-hex="#ffffff">
                                    <input type="checkbox" class="color-checkbox" name="color" value="White" id="color_white" hidden
                                        {% if 'White' in product.color %}checked{% endif %}>
                                    <label for="color_white" class="color-label">
                                        <span class="color-swatch" style="background-color: #ffffff; border: 1px solid #ddd;"></span>
                                        <span class="color-name">White</span>
                                    </label>
                                </div>
                            </div>
                            <!-- Navy Blue -->
                            <div class="col-md-2 col-4 mb-2">
                                <div class="color-option" data-color="Navy Blue" data-hex="#000080">
                                    <input type="checkbox" class="color-checkbox" name="color" value="Navy Blue" id="color_navy" hidden
                                        {% if 'Navy Blue' in product.color %}checked{% endif %}>
                                    <label for="color_navy" class="color-label">
                                        <span class="color-swatch" style="background-color: #000080;"></span>
                                        <span class="color-name">Navy Blue</span>
                                    </label>
                                </div>
                            </div>
                            <!-- Cream -->
                            <div class="col-md-2 col-4 mb-2">
                                <div class="color-option" data-color="Cream" data-hex="#fffdd0">
                                    <input type="checkbox" class="color-checkbox" name="color" value="Cream" id="color_cream" hidden
                                        {% if 'Cream' in product.color %}checked{% endif %}>
                                    <label for="color_cream" class="color-label">
                                        <span class="color-swatch" style="background-color: #fffdd0; border: 1px solid #ddd;"></span>
                                        <span class="color-name">Cream</span>
                                    </label>
                                </div>
                            </div>
                            <!-- Add Custom Color Button -->
                            <div class="col-md-2 col-4 mb-2">
                                <div class="color-option add-color-option" onclick="openColorModal()">
                                    <div class="color-label text-center">
                                        <span class="color-swatch add-color-swatch">
                                            <i class="fas fa-plus"></i>
                                        </span>
                                        <span class="color-name">Add Color</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Selected Colors Display -->
                    <div class="selected-colors-container mb-3">
                        <label>Selected Colors:</label>
                        <div id="selectedColors" class="d-flex flex-wrap gap-2 mt-2">
                            <!-- Selected colors will appear here dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Custom Color Modal -->
                <div class="modal fade" id="colorModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-sm">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add Custom Color</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="customColorName" class="form-label">Color Name</label>
                                    <input type="text" class="form-control" id="customColorName" placeholder="e.g., Burgundy" maxlength="50">
                                </div>
                                <div class="mb-3">
                                    <label for="customColorPicker" class="form-label">Select Color</label>
                                    <input type="color" class="form-control form-control-color" id="customColorPicker" value="#ff0000">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="addCustomColor()">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="hiddenColorInputs" style="display: none;">
                    <!-- Hidden inputs for color data will be added here -->
                </div>

                <!-- Rest of your form fields -->
                <div class="form-group">
                    <label for="brand_id">Brand</label>
                    <select name="brand_id" class="form-control">
                        <option value="">--Select Brand--</option>
                        {% for brand in brands %}
                        <option value="{{ brand.id }}" {% if product.brand.id == brand.id %}selected{% endif %}>{{ brand.title }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="condition">Condition</label>
                    <select name="condition" class="form-control">
                        <option value="">--Select Condition--</option>
                        <option value="default" {% if product.condition == 'default' %}selected{% endif %}>Default</option>
                        <option value="new" {% if product.condition == 'new' %}selected{% endif %}>New</option>
                        <option value="hot" {% if product.condition == 'hot' %}selected{% endif %}>Hot</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="stock">Quantity <span class="text-danger">*</span></label>
                    <input id="stock" type="number" name="stock" min="0" placeholder="Enter quantity"
                        value="{% if request.POST.stock %}{{ request.POST.stock }}{% else %}{{ product.stock|default_if_none:'' }}{% endif %}" 
                        class="form-control" required>
                </div>

                <div class="mb-3">
                    <label>Current Photo/Video</label><br>
                    {% if product.photo %}
                        {% if product.photo.url|lower|slice:"-4:" == '.mp4' or product.photo.url|lower|slice:"-5:" == '.webm' %}
                            <video width="320" height="240" controls><source src="{{ product.photo.url }}" type="video/mp4"></video>
                        {% else %}
                            <img src="{{ product.photo.url }}" width="150" class="img-thumbnail">
                        {% endif %}
                    {% else %}
                        <p>No current file uploaded.</p>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="photo">Change Photo/Video</label>
                    <input id="photo" class="form-control" type="file" name="photo">
                    <small class="form-text text-muted">Leave blank to keep current file.</small>
                </div>

                <div class="form-group d-none">
                    <label for="status">Status <span class="text-danger">*</span></label>
                    <select name="status" class="form-control">
                        <option value="active" {% if product.status == 'active' %}selected{% endif %}>Active</option>
                        <option value="inactive" {% if product.status == 'inactive' %}selected{% endif %}>Inactive</option>
                    </select>
                </div>
                
                <!-- Debug Information -->
                <div class="mt-3 p-3 bg-light border rounded">
                    <h6>Debug Information:</h6>
                    <div id="debugInfo" class="small"></div>
                </div>

                <button type="submit" class="btn btn-primary mt-3">✅ Update Product</button>
                <a href="{% url 'product_list' %}" class="btn btn-secondary mt-3">Cancel</a>
            </form>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// Store for color mapping (name -> hex)
const colorMap = {
    'Black': '#000000',
    'White': '#ffffff',
    'Navy Blue': '#000080',
    'Cream': '#fffdd0'
};

// Function to prepare color inputs for form submission
function prepareColorInputs() {
    const hiddenContainer = $('#hiddenColorInputs');
    hiddenContainer.empty();
    
    $('.color-checkbox:checked').each(function() {
        const colorName = $(this).val();
        const colorHex = colorMap[colorName] || '#cccccc';
        
        const nameInput = `<input type="hidden" name="color_name" value="${colorName}">`;
        const codeInput = `<input type="hidden" name="color_code" value="${colorHex}">`;
        
        hiddenContainer.append(nameInput);
        hiddenContainer.append(codeInput);
    });
}

// Initialize on page load
$(document).ready(function() {
    // Initialize color display with existing values
    updateSelectedColorsDisplay();
    
    // Handle color selection
    $('.color-option:not(.add-color-option)').on('click', function() {
        const checkbox = $(this).find('.color-checkbox');
        checkbox.prop('checked', !checkbox.prop('checked'));
        updateSelectedColorsDisplay();
    });
    
    // Initialize existing custom colors from the product
    initializeExistingCustomColors();
});

// Function to initialize existing custom colors
function initializeExistingCustomColors() {
    // Get all checked color checkboxes
    $('.color-checkbox:checked').each(function() {
        const colorName = $(this).val();
        const colorHex = colorMap[colorName] || '#cccccc';
        
        // If this color is not in our default colorMap, it's a custom color
        if (!['Black', 'White', 'Navy Blue', 'Cream'].includes(colorName)) {
            // Add it to our colorMap
            colorMap[colorName] = colorHex;
        }
    });
}

// Function to open modal
function openColorModal() {
    $('#customColorName').val('');
    $('#customColorPicker').val('#ff0000');
    
    var colorModal = new bootstrap.Modal(document.getElementById('colorModal'));
    colorModal.show();
}

function addCustomColor() {
    const colorName = $('#customColorName').val().trim();
    const colorHex = $('#customColorPicker').val();

    if (!colorName) {
        alert('Please enter a color name');
        return;
    }

    if (colorMap[colorName]) {
        alert('Color name already exists! Please use a different name.');
        return;
    }

    colorMap[colorName] = colorHex;
    createColorOption(colorName, colorHex);
    
    var colorModal = bootstrap.Modal.getInstance(document.getElementById('colorModal'));
    colorModal.hide();
    
    showTempMessage(`Color "${colorName}" added successfully!`, 'success');
}

function createColorOption(colorName, colorHex) {
    const colorId = 'color_' + colorName.replace(/\s+/g, '_').toLowerCase();
    
    const colorOption = `
        <div class="col-md-2 col-4 mb-2">
            <div class="color-option" data-color="${colorName}" data-hex="${colorHex}">
                <input type="checkbox" class="color-checkbox" name="color" value="${colorName}" id="${colorId}" hidden checked>
                <label for="${colorId}" class="color-label">
                    <span class="color-swatch" style="background-color: ${colorHex}; ${colorHex === '#ffffff' || colorHex === '#fffdd0' ? 'border: 1px solid #ddd;' : ''}"></span>
                    <span class="color-name">${colorName}</span>
                </label>
            </div>
        </div>
    `;
    
    $('.add-color-option').parent().before(colorOption);
    
    $(`.color-option[data-color="${colorName}"]`).on('click', function() {
        const checkbox = $(this).find('.color-checkbox');
        checkbox.prop('checked', !checkbox.prop('checked'));
        updateSelectedColorsDisplay();
    });
    
    // Update display after adding new color
    updateSelectedColorsDisplay();
}

function removeColor(colorName) {
    $(`.color-checkbox[value="${colorName}"]`).prop('checked', false);
    updateSelectedColorsDisplay();
    showTempMessage(`Color "${colorName}" removed!`, 'warning');
}

function updateSelectedColorsDisplay() {
    const displayContainer = $('#selectedColors');
    displayContainer.empty();
    
    $('.color-checkbox:checked').each(function() {
        const colorName = $(this).val();
        const colorHex = colorMap[colorName] || '#cccccc';
        const textColor = getTextColor(colorHex);
        
        const colorBadge = `
            <div class="selected-color-badge" style="background-color: ${colorHex}; color: ${textColor};">
                ${colorName}
                <button type="button" class="remove-color-btn" onclick="removeColor('${colorName}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        displayContainer.append(colorBadge);
    });
}

function getTextColor(backgroundColor) {
    const hex = backgroundColor.replace('#', '');
    const r = parseInt(hex.substr(0, 2), 16);
    const g = parseInt(hex.substr(2, 2), 16);
    const b = parseInt(hex.substr(4, 2), 16);
    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
    return luminance > 0.5 ? '#000000' : '#ffffff';
}

function showTempMessage(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-warning';
    const alertDiv = $(`<div class="alert ${alertClass} alert-dismissible fade show mt-2">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`);
    
    $('.selected-colors-container').append(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}

// Form submission handler
$('form').on('submit', function() {
    prepareColorInputs();
    
    const selectedColors = $('.color-checkbox:checked').length;
    if (selectedColors === 0) {
        alert('Please select at least one color');
        return false;
    }
    
    const selectedSizes = $('input[name="size"]:checked').length;
    if (selectedSizes === 0) {
        alert('Please select at least one size');
        return false;
    }
});

// Category AJAX functionality
$(document).ready(function() {
    function loadChildCategories(parent_id, child_cat_id_to_select) {
        if(parent_id) {
            $.ajax({
                url: "{% url 'get_child_categories' %}",
                data: { parent_id: parent_id },
                dataType: "json",
                success: function(response) {
                    var childCatSelect = $("#child_cat_id");
                    childCatSelect.empty();
                    
                    if(response.child_categories.length > 0){
                        $("#child_cat_div").removeClass("d-none");
                        childCatSelect.append('<option value="">--Select any sub category--</option>');
                        $.each(response.child_categories, function(i, cat) {
                            var is_selected = (cat.id == child_cat_id_to_select);
                            childCatSelect.append('<option value="'+cat.id+'" ' + (is_selected ? 'selected' : '') + '>'+cat.title+'</option>');
                        });
                    } else {
                        $("#child_cat_div").addClass("d-none");
                    }
                }
            });
        } else {
            $("#child_cat_div").addClass("d-none");
        }
    }
   
    var initialParentId = $("#cat_id").val();
    var initialChildId = "{{ product.child_category.id|default:'' }}";
    if (initialParentId) {
      loadChildCategories(initialParentId, initialChildId);
    }
 
    $("#cat_id").change(function() {
        var parent_id = $(this).val();
        loadChildCategories(parent_id, '');
    });
});
</script>
{% endblock %}