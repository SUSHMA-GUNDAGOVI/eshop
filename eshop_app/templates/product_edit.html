{% extends 'admin_base.html' %}

{% block title %}Edit Product: {{ product.title }}{% endblock %}

{% block content %}
<style>
.color-selection-grid {
    border: 1px solid #e3e6f0;
    border-radius: 8px;
    padding: 15px;
    background: #f8f9fc;
}

.color-option {
    cursor: pointer;
    transition: all 0.3s ease;
}

.color-option:hover {
    transform: translateY(-2px);
}

.color-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    padding: 10px 5px;
    border-radius: 8px;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.color-label:hover {
    background: rgba(0,0,0,0.05);
}

.color-checkbox:checked + .color-label {
    border-color: #4e73df;
    background: rgba(78, 115, 223, 0.1);
}

.color-swatch {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin-bottom: 8px;
    border: 2px solid transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.color-checkbox:checked + .color-label .color-swatch {
    border-color: #333;
    transform: scale(1.1);
}

.add-color-swatch {
    background: #f8f9fc;
    border: 2px dashed #dee2e6;
    color: #6c757d;
    font-size: 1.2rem;
}

.add-color-option:hover .add-color-swatch {
    background: #e9ecef;
    border-color: #4e73df;
    color: #4e73df;
}

.color-name {
    font-size: 0.8rem;
    text-align: center;
    font-weight: 500;
    color: #5a5c69;
}

.selected-color-badge {
    border-radius: 20px;
    padding: 8px 12px;
    font-size: 0.8rem;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    min-width: 80px;
    justify-content: space-between;
    margin: 5px;
}

.remove-color-btn {
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    padding: 0;
    margin-left: 5px;
    opacity: 0.7;
}

.remove-color-btn:hover {
    opacity: 1;
}

.form-control-color {
    height: 50px;
    width: 100%;
}
</style>

<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h1 class="h3 text-gray-800">Product Management</h1>
    </div>

    <!-- Edit Product Form -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Edit Product</h6>
        </div>
        <div class="card-body">
            {% if error_message %}
            <div class="alert alert-danger">{{ error_message }}</div>
            {% endif %}
            {% if success_message %}
            <div class="alert alert-success">{{ success_message }}</div>
            {% endif %}

            <form method="post" enctype="multipart/form-data" id="productForm">
                {% csrf_token %}

                <div class="form-group">
                    <label for="inputTitle">Title <span class="text-danger">*</span></label>
                    <input id="inputTitle" type="text" name="title" placeholder="Enter title"
                        value="{{ request.POST.title|default:product.title }}" class="form-control">
                </div>

                <!-- Description -->
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea class="form-control" id="description"
                        name="description">{{ request.POST.description|default:product.description }}</textarea>
                </div>

                <!-- Featured -->
                <div class="form-group">
                    <label for="is_featured">Is Featured</label><br>
                    <input type="checkbox" name="is_featured" id="is_featured" value="1" {% if request.POST.is_featured or product.is_featured %}checked{% endif %}> Yes
                </div>

         <div class="form-group">
    <label>Category *</label>
    <select name="cat_id" id="cat_id" class="form-control" required>
        <option value="">--Select category--</option>
        {% for cat in categories %}
            <option value="{{ cat.id }}" {% if product.category.id == cat.id %}selected{% endif %}>{{ cat.title }}</option>
        {% endfor %}
    </select>
</div>

<div class="form-group" id="subcategory-group" style="{% if product.child_category %}display: block;{% else %}display: none;{% endif %}">
    <label>Sub Category</label>
    <select name="child_cat_id" id="child_cat_id" class="form-control">
        <option value="">--Select child category--</option>
        {% if product.child_category %}
            <option value="{{ product.child_category.id }}" selected>{{ product.child_category.title }}</option>
        {% endif %}
    </select>
</div>

                <!-- Price -->
                <div class="form-group">
                    <label for="price">Price (â‚¹) <span class="text-danger">*</span></label>
                    <input id="price" type="number" name="price" placeholder="Enter price"
                        value="{{ request.POST.price|default:product.price }}" class="form-control">
                </div>

               

                <!-- Size -->
                <div class="form-group">
                    <label for="size">Size <span class="text-danger">*</span></label>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="size" value="S" id="size_s" {% if 'S' in product.size %}checked{% endif %}>
                                <label class="form-check-label" for="size_s">Small (S)</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="size" value="M" id="size_m" {% if 'M' in product.size %}checked{% endif %}>
                                <label class="form-check-label" for="size_m">Medium (M)</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="size" value="L" id="size_l" {% if 'L' in product.size %}checked{% endif %}>
                                <label class="form-check-label" for="size_l">Large (L)</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="size" value="XL" id="size_xl" {% if 'XL' in product.size %}checked{% endif %}>
                                <label class="form-check-label" for="size_xl">Extra Large (XL)</label>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="size" value="XXL" id="size_xxl" {% if 'XXL' in product.size %}checked{% endif %}>
                                <label class="form-check-label" for="size_xxl">XXL</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="size" value="XXXL" id="size_xxxl" {% if 'XXXL' in product.size %}checked{% endif %}>
                                <label class="form-check-label" for="size_xxxl">XXXL</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Color - Multiple Selection -->
                <div class="form-group">
                    <label for="color">Color <span class="text-danger">*</span></label>
                    
                    <!-- Color Selection Grid -->
                    <div class="color-selection-grid mb-3">
                        <div class="row" id="colorGrid">
                            <!-- Black -->
                            <div class="col-md-2 col-4 mb-2">
                                <div class="color-option" data-color="Black" data-hex="#000000">
                                    <input type="checkbox" class="color-checkbox" name="color" value="Black" id="color_black" hidden {% if 'Black' in product.color_names %}checked{% endif %}>
                                    <label for="color_black" class="color-label">
                                        <span class="color-swatch" style="background-color: #000000;"></span>
                                        <span class="color-name">Black</span>
                                    </label>
                                </div>
                            </div>
                            <!-- White -->
                            <div class="col-md-2 col-4 mb-2">
                                <div class="color-option" data-color="White" data-hex="#ffffff">
                                    <input type="checkbox" class="color-checkbox" name="color" value="White" id="color_white" hidden {% if 'White' in product.color_names %}checked{% endif %}>
                                    <label for="color_white" class="color-label">
                                        <span class="color-swatch" style="background-color: #ffffff; border: 1px solid #ddd;"></span>
                                        <span class="color-name">White</span>
                                    </label>
                                </div>
                            </div>
                            <!-- Navy Blue -->
                            <div class="col-md-2 col-4 mb-2">
                                <div class="color-option" data-color="Navy Blue" data-hex="#000080">
                                    <input type="checkbox" class="color-checkbox" name="color" value="Navy Blue" id="color_navy" hidden {% if 'Navy Blue' in product.color_names %}checked{% endif %}>
                                    <label for="color_navy" class="color-label">
                                        <span class="color-swatch" style="background-color: #000080;"></span>
                                        <span class="color-name">Navy Blue</span>
                                    </label>
                                </div>
                            </div>
                            <!-- Cream -->
                            <div class="col-md-2 col-4 mb-2">
                                <div class="color-option" data-color="Cream" data-hex="#fffdd0">
                                    <input type="checkbox" class="color-checkbox" name="color" value="Cream" id="color_cream" hidden {% if 'Cream' in product.color_names %}checked{% endif %}>
                                    <label for="color_cream" class="color-label">
                                        <span class="color-swatch" style="background-color: #fffdd0; border: 1px solid #ddd;"></span>
                                        <span class="color-name">Cream</span>
                                    </label>
                                </div>
                            </div>
                            <!-- Add Custom Color Button -->
                            <div class="col-md-2 col-4 mb-2">
                                <div class="color-option add-color-option" onclick="openColorModal()">
                                    <div class="color-label text-center">
                                        <span class="color-swatch add-color-swatch">
                                            <i class="fas fa-plus"></i>
                                        </span>
                                        <span class="color-name">Add Color</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Selected Colors Display -->
                    <div class="selected-colors-container mb-3">
                        <label>Selected Colors:</label>
                        <div id="selectedColors" class="d-flex flex-wrap gap-2 mt-2">
                            <span class="text-muted">No colors selected</span>
                        </div>
                    </div>

                    <!-- Color-Specific Media Uploads -->
<div id="colorMediaContainer" class="mt-3">
    <!-- Color-specific file upload areas will appear here -->
</div>
                </div>

                <!-- Hidden Color Inputs -->
                <div id="hiddenColorInputs"></div>

                <!-- Brand -->
                <div class="form-group">
                    <label for="brand_id">Brand</label>
                    <select name="brand_id" class="form-control">
                        <option value="">--Select Brand--</option>
                        {% for brand in brands %}
                        <option value="{{ brand.id }}" {% if product.brand.id == brand.id %}selected{% endif %}>{{ brand.title }}</option>
                        {% endfor %}
                    </select>
                </div>

                 <!-- Discount -->
                <div class="form-group">
                    <label for="discount">Discount (%)</label>
                    <input id="discount" type="number" name="discount" min="0" max="100" placeholder="Enter discount"
                        value="{{ request.POST.discount|default:product.discount|default:0 }}" class="form-control">
                </div>

                <!-- Condition -->
                <div class="form-group">
                    <label for="condition">Condition</label>
                    <select name="condition" class="form-control">
                        <option value="">--Select Condition--</option>
                        <option value="default" {% if product.condition == 'default' %}selected{% endif %}>Default</option>
                        <option value="new" {% if product.condition == 'new' %}selected{% endif %}>New</option>
                        <option value="hot" {% if product.condition == 'hot' %}selected{% endif %}>Hot</option>
                    </select>
                </div>
                
                <div class="form-group">
    <label for="deal_end_date ">End Deal Date/Time</label>
    <input type="datetime-local" name="deal_end_date" id="deal_end_date" class="form-control" value="{% if product.deal_end_date %}{{ product.deal_end_date|date:'Y-m-d\TH:i' }}{% endif %}">
    <small class="text-muted">Leave blank if not a limited-time deal.</small>
</div>
                

                <!-- Quantity -->
                <div class="form-group">
                    <label for="stock">Quantity <span class="text-danger">*</span></label>
                    <input id="stock" type="number" name="stock" min="0" placeholder="Enter quantity"
                        value="{{ request.POST.stock|default:product.stock }}" class="form-control">
                </div>
<div class="form-group">
    <label for="shipping_option">Shipping Option</label>
    <select id="shipping_option" name="shipping_option" class="form-control" onchange="toggleShippingInput(this.value)">
        <option value="free" {% if product.is_free_shipping %}selected{% endif %}>Free Shipping</option>
        <option value="custom" {% if not product.is_free_shipping %}selected{% endif %}>Custom Shipping Charge</option>
    </select>
</div>

<div class="form-group" id="shipping_charge_group" style="{% if not product.is_free_shipping %}display: block;{% else %}display: none;{% endif %}">
    <label for="shipping_charge">Shipping Charge (â‚¹)</label>
    <input id="shipping_charge" type="number" name="shipping_charge" step="0.01" min="0"
        value="{{ product.shipping_charge|default:0 }}" placeholder="Enter shipping charge (e.g. 50)" class="form-control">
</div>

<div class="form-group">
    <label for="status">Status <span class="text-danger">*</span></label>
    <select id="status" name="status" class="form-control" required>
        <option value="active" {% if product.status == 'active' %}selected{% endif %}>Active</option>
        <option value="inactive" {% if product.status == 'inactive' %}selected{% endif %}>Inactive</option>
    </select>
</div> 

               

                <!-- Submit Buttons -->
                <button type="submit" class="btn btn-success mt-3">ðŸ’¾ Update Product</button>
                <a href="{% url 'product_list' %}" class="btn btn-secondary mt-3">Cancel</a>
            </form>
        </div>
    </div>
</div>

<!-- Custom Color Modal -->
<div class="modal fade" id="colorModal" tabindex="-1" aria-labelledby="colorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="colorModalLabel">Add Custom Color</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="customColorName" class="form-label">Color Name</label>
                    <input type="text" class="form-control" id="customColorName" placeholder="e.g., Burgundy" maxlength="50">
                </div>
                <div class="mb-3">
                    <label for="customColorPicker" class="form-label">Select Color</label>
                    <input type="color" class="form-control form-control-color" id="customColorPicker" value="#ff0000">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addCustomColor()">
                    <i class="fas fa-plus"></i> Add
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
const existingMedia = {{ media_by_color|safe }};
const colorData = {{ color_data|safe }};
</script>
<script>
// Store for color mapping (name -> hex)
const colorMap = {
    {% for color_name, color_hex in color_map.items %}
    '{{ color_name }}': '{{ color_hex }}',
    {% endfor %}
};

// Initialize on page load
$(document).ready(function() {
    console.log('Document ready - initializing color selector');
    
    // Initialize existing colors
    initializeExistingColors();
    
    // Update display on load
    updateSelectedColorsDisplay();
    
    // Handle color selection - Use event delegation
    $(document).on('click', '.color-option:not(.add-color-option)', function(e) {
        e.preventDefault();
        const checkbox = $(this).find('.color-checkbox');
        checkbox.prop('checked', !checkbox.prop('checked'));
        updateSelectedColorsDisplay();
    });
});

// Function to initialize existing colors
function initializeExistingColors() {
    // Uncheck all first
    $('.color-checkbox').prop('checked', false);
    
    // Check predefined if in existing
    const existingNames = colorData.map(c => c.name);
    $('.color-checkbox').each(function() {
        if (existingNames.includes($(this).val())) {
            $(this).prop('checked', true);
        }
    });
    
    // Create options for custom colors not predefined
    const predefined = ['Black', 'White', 'Navy Blue', 'Cream'];
    existingNames.forEach(name => {
        if (!predefined.includes(name) && !$(`[data-color="${name}"]`).length) {
            const hex = colorMap[name] || '#cccccc';
            createColorOption(name, hex);
            // Check it
            $(`.color-checkbox[value="${name}"]`).prop('checked', true);
        }
    });
}

// Function to open modal
function openColorModal() {
    console.log('Opening color modal');
    // Reset form
    $('#customColorName').val('');
    $('#customColorPicker').val('#ff0000');
    
    // Show modal using Bootstrap 5
    const modalElement = document.getElementById('colorModal');
    const colorModal = new bootstrap.Modal(modalElement);
    colorModal.show();
}

// Function to add custom color
function addCustomColor() {
    const colorName = $('#customColorName').val().trim();
    const colorHex = $('#customColorPicker').val();

    if (!colorName) {
        alert('Please enter a color name');
        return;
    }

    // Check if color name already exists
    if (colorMap[colorName]) {
        alert('Color name already exists! Please use a different name.');
        return;
    }

    // Add to color map
    colorMap[colorName] = colorHex;
    
    // Create new color option
    createColorOption(colorName, colorHex);
    
    // Close modal
    const modalElement = document.getElementById('colorModal');
    const colorModal = bootstrap.Modal.getInstance(modalElement);
    colorModal.hide();
    
    showTempMessage('Color "' + colorName + '" added successfully!', 'success');
}

// Create new color option element
function createColorOption(colorName, colorHex) {
    const safeColor = colorName.replace(/\s+/g, '_');
    const colorId = 'color_' + safeColor.toLowerCase();
    const borderStyle = (colorHex === '#ffffff' || colorHex === '#fffdd0') ? 'border: 1px solid #ddd;' : '';
    
    const colorOption = '<div class="col-md-2 col-4 mb-2">' +
        '<div class="color-option" data-color="' + colorName + '" data-hex="' + colorHex + '">' +
            '<input type="checkbox" class="color-checkbox" name="color" value="' + colorName + '" id="' + colorId + '" hidden>' +
            '<label for="' + colorId + '" class="color-label">' +
                '<span class="color-swatch" style="background-color: ' + colorHex + '; ' + borderStyle + '"></span>' +
                '<span class="color-name">' + colorName + '</span>' +
            '</label>' +
        '</div>' +
    '</div>';
    
    // Add before the "Add Color" button
    $('.add-color-option').parent().before(colorOption);
    
    // Bind click for new option
    $(document).off('click', `.color-option[data-color="${colorName}"]`).on('click', `.color-option[data-color="${colorName}"]`, function(e) {
        e.preventDefault();
        const checkbox = $(this).find('.color-checkbox');
        checkbox.prop('checked', !checkbox.prop('checked'));
        updateSelectedColorsDisplay();
    });
}

// Remove color from selection
function removeColor(colorName) {
    $(`.color-checkbox[value="${colorName}"]`).prop('checked', false);
    updateSelectedColorsDisplay();
    showTempMessage('Color "' + colorName + '" removed!', 'warning');
}

// Update the selected colors display
function updateSelectedColorsDisplay() {
    const displayContainer = $('#selectedColors');
    const colorMediaContainer = $('#colorMediaContainer');
    displayContainer.empty();
    colorMediaContainer.empty();
    
    const checkedColors = $('.color-checkbox:checked');
    
    if (checkedColors.length === 0) {
        displayContainer.html('<span class="text-muted">No colors selected</span>');
        return;
    }

    checkedColors.each(function() {
        const colorName = $(this).val();
        const colorHex = colorMap[colorName] || '#cccccc';
        const textColor = getTextColor(colorHex);
        
        // Selected color badge
        const colorBadge = `
            <div class="selected-color-badge" style="background-color:${colorHex}; color:${textColor}">
                ${colorName}
                <button type="button" class="remove-color-btn" onclick="removeColor('${colorName}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>`;
        displayContainer.append(colorBadge);

        // Existing media for this color
        let existingHtml = '';
        const mediaList = existingMedia[colorName] || [];
        if (mediaList.length > 0) {
            mediaList.forEach(m => {
                const mediaTag = m.type === 'image' ? 
                    `<img src="${m.url}" class="img-thumbnail me-2 mb-2" style="width: 100px; height: 100px; object-fit: cover;" alt="${m.name}">` :
                    `<video src="${m.url}" class="img-thumbnail me-2 mb-2" style="width: 100px; height: 100px;" controls>
                        <source src="${m.url}" type="video/mp4">
                    </video>`;
                existingHtml += `
                    <div class="position-relative d-inline-block">
                        ${mediaTag}
                        <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0" onclick="removeMedia(${m.id})" title="Remove">
                            <i class="fas fa-times"></i>
                        </button>
                        {% if m.is_primary %}<span class="badge bg-primary ms-1">Primary</span>{% endif %}
                    </div>`;
            });
        }

        // Safe name for input
        const safeColor = colorName.replace(/\s+/g, '_');

        // Create upload input for that color
        const colorUploadBlock = `
            <div class="form-group border rounded p-3 mb-3">
                <label><strong>${colorName}</strong> - Upload Images/Videos</label>
                ${existingHtml ? `<div class="existing-media mb-2">${existingHtml}</div>` : ''}
                <input type="file" name="media_files_${safeColor}" multiple accept="image/*,video/*" class="form-control media-input" data-color="${colorName}">
                <div class="preview mt-2 text-muted small">No files selected</div>
            </div>`;
        colorMediaContainer.append(colorUploadBlock);
    });

    // Bind change event for media inputs
    $('.media-input').off('change').on('change', function() {
        const previewDiv = $(this).siblings('.preview');
        const files = this.files;
        if (files.length > 0) {
            let list = '<ul class="list-unstyled mb-0">';
            for (let i = 0; i < files.length; i++) {
                list += `<li><i class="fas fa-file"></i> ${files[i].name}</li>`;
            }
            list += '</ul>';
            previewDiv.html(list);
        } else {
            previewDiv.html('No files selected');
        }
    });

    // Handle uncategorized media (color_name == '')
    const uncatMedia = existingMedia[''] || [];
    if (uncatMedia.length > 0) {
        let uncatHtml = '';
        uncatMedia.forEach(m => {
            const mediaTag = m.type === 'image' ? 
                `<img src="${m.url}" class="img-thumbnail me-2 mb-2" style="width: 100px; height: 100px; object-fit: cover;" alt="${m.name}">` :
                `<video src="${m.url}" class="img-thumbnail me-2 mb-2" style="width: 100px; height: 100px;" controls>
                    <source src="${m.url}" type="video/mp4">
                </video>`;
            uncatHtml += `
                <div class="position-relative d-inline-block">
                    ${mediaTag}
                    <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0" onclick="removeMedia(${m.id})" title="Remove">
                        <i class="fas fa-times"></i>
                    </button>
                    {% if m.is_primary %}<span class="badge bg-primary ms-1">Primary</span>{% endif %}
                </div>`;
        });

        const uncatBlock = `
            <div class="form-group border rounded p-3 mb-3">
                <label><strong>Media without Color Association</strong> - Existing Files</label>
                <div class="existing-media mb-2">${uncatHtml}</div>
                <input type="file" name="media_files" multiple accept="image/*,video/*" class="form-control media-input" data-color="">
                <div class="preview mt-2 text-muted small">No files selected</div>
            </div>`;
        colorMediaContainer.append(uncatBlock);
    }
}

// Calculate text color based on background
function getTextColor(backgroundColor) {
    const hex = backgroundColor.replace('#', '');
    const r = parseInt(hex.substr(0, 2), 16);
    const g = parseInt(hex.substr(2, 2), 16);
    const b = parseInt(hex.substr(4, 2), 16);
    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
    return luminance > 0.5 ? '#000000' : '#ffffff';
}

// Show temporary message
function showTempMessage(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-warning';
    const alertDiv = $('<div class="alert ' + alertClass + ' alert-dismissible fade show mt-2">' +
        message +
        '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
    '</div>');
    
    $('.selected-colors-container').append(alertDiv);
    
    setTimeout(function() {
        alertDiv.remove();
    }, 3000);
}

// Prepare color inputs for form submission
function prepareColorInputs() {
    const hiddenContainer = $('#hiddenColorInputs');
    hiddenContainer.empty();
    
    // Get all checked colors
    $('.color-checkbox:checked').each(function() {
        const colorName = $(this).val();
        const colorHex = colorMap[colorName] || '#cccccc';
        
        // Create hidden inputs for each selected color
        const nameInput = '<input type="hidden" name="color_name" value="' + colorName + '">';
        const codeInput = '<input type="hidden" name="color_code" value="' + colorHex + '">';
        
        hiddenContainer.append(nameInput);
        hiddenContainer.append(codeInput);
    });
}

// Form submission handler
$('#productForm').on('submit', function(e) {
    // Prepare color inputs
    prepareColorInputs();
    
    // Validate at least one color is selected
    const selectedColors = $('.color-checkbox:checked').length;
    if (selectedColors === 0) {
        e.preventDefault();
        alert('Please select at least one color');
        return false;
    }
    
    return true;
});
</script>
<script>
function toggleShippingInput(option) {
    const chargeGroup = document.getElementById('shipping_charge_group');
    const chargeInput = document.getElementById('shipping_charge');

    if (option === 'custom') {
        chargeGroup.style.display = 'block';
        chargeInput.required = true;
    } else {
        chargeGroup.style.display = 'none';
        chargeInput.required = false;
        chargeInput.value = '';
    }
}

// Preserve visibility on page load
document.addEventListener('DOMContentLoaded', () => {
    const shippingOption = document.getElementById('shipping_option').value;
    toggleShippingInput(shippingOption);
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const categorySelect = document.getElementById("cat_id");
    const subcategoryGroup = document.getElementById("subcategory-group");
    const childCategorySelect = document.getElementById("child_cat_id");

    // Initial load if category selected
    if (categorySelect.value) {
        subcategoryGroup.style.display = "block";
        loadChildCategories(categorySelect.value, childCategorySelect.value);
    }

    categorySelect.addEventListener("change", function () {
        const parentId = this.value;

        // If no parent selected â†’ hide subcategory
        if (!parentId) {
            subcategoryGroup.style.display = "none";
            childCategorySelect.innerHTML = '<option value="">--Select child category--</option>';
            return;
        }

        // Show subcategory dropdown while loading
        subcategoryGroup.style.display = "block";
        childCategorySelect.innerHTML = '<option value="">--Loading--</option>';

        loadChildCategories(parentId, '');
    });

    function loadChildCategories(parentId, selectedId) {
        fetch(`/get-child-categories/${parentId}/`)
            .then(response => response.json())
            .then(data => {
                childCategorySelect.innerHTML = '<option value="">--Select child category--</option>';

                if (data.length === 0) {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'No subcategories available';
                    childCategorySelect.appendChild(opt);
                    return;
                }

                data.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat.id;
                    opt.textContent = cat.title;
                    if (cat.id == selectedId) opt.selected = true;
                    childCategorySelect.appendChild(opt);
                });
            })
            .catch(error => {
                console.error("Error fetching child categories:", error);
                childCategorySelect.innerHTML = '<option value="">--Error loading--</option>';
            });
    }
});
</script>

<script>
// Function to remove media file
function removeMedia(mediaId) {
    if (confirm('Are you sure you want to remove this file? This action cannot be undone.')) {
        fetch(`/remove-media/${mediaId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Reload to update display
            } else {
                alert('Error removing file: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error removing file');
        });
    }
}
</script>

{% endblock %}