{% extends 'admin_base.html' %}

{% block title %}Edit Category{% endblock %}

{% block content %}
<div class="container-fluid">

    <!-- Page Heading -->
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h1 class="h3 text-gray-800">Category Management</h1>
    </div>

    <!-- Edit Category Form -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Edit Category</h6>
        </div>
        <div class="card-body">
            {% if error %}
                <div class="alert alert-danger">{{ error }}</div>
            {% endif %}
            {% if success %}
                <div class="alert alert-success">{{ success }}</div>
            {% endif %}

            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- Category Title -->
                <div class="form-group">
                    <label for="id_title">Category Title <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="id_title" name="title"
                           value="{{ category.title }}" required>
                </div>

                <!-- Is Parent Checkbox -->
                <div class="form-group">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="id_is_parent"
                               name="is_parent" value="1"
                               {% if category.is_parent %}checked{% endif %}>
                        <label class="custom-control-label" for="id_is_parent">Is Parent Category?</label>
                    </div>
                </div>

                <!-- Parent Category Dropdown -->
                <div class="form-group" id="parent_category_group"
                     {% if category.is_parent %}style="display:none;"{% endif %}>
                    <label for="id_parent_id">Select Parent Category <span class="text-danger">*</span></label>
                    <select class="form-control" id="id_parent_id" name="parent_id">
                        <option value="">--- Select Parent ---</option>
                        {% for cat in parent_cats %}
                            <option value="{{ cat.id }}" 
                                    {% if category.parent_id == cat.id %}selected{% endif %}>
                                {{ cat.title }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Category Image Upload -->
                <div class="form-group" id="photo_group">
                    <label for="id_photo">Upload Category Image</label>
                    <input type="file" class="form-control-file" id="id_photo" name="photo" accept="image/*">

                    {% if category.photo %}
                        <div class="mt-2">
                            <img src="{{ category.photo.url }}" alt="{{ category.title }}" 
                                 class="img-thumbnail" style="max-width: 150px;">
                        </div>
                        <small class="form-text text-muted">
                            Leave blank to keep the current image.
                        </small>
                    {% endif %}
                </div>

                <!-- Status -->
                <div class="form-group">
                    <label for="id_status">Status <span class="text-danger">*</span></label>
                    <select class="form-control" id="id_status" name="status" required>
                        <option value="active" {% if category.status == 'active' %}selected{% endif %}>Active</option>
                        <option value="inactive" {% if category.status == 'inactive' %}selected{% endif %}>Inactive</option>
                    </select>
                </div>

                <!-- Submit Buttons -->
                <button type="submit" class="btn btn-success mt-3">ðŸ’¾ Update Category</button>
                <a href="{% url 'category_list' %}" class="btn btn-secondary mt-3">Cancel</a>
            </form>
        </div>
    </div>
</div>

<!-- Dynamic Script -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const isParentCheckbox = document.getElementById('id_is_parent');
        const parentCategoryGroup = document.getElementById('parent_category_group');
        const photoGroup = document.getElementById('photo_group');
        const parentIdSelect = document.getElementById('id_parent_id');

        function toggleParentField() {
            if (isParentCheckbox.checked) {
                // âœ… It's a parent category
                parentCategoryGroup.style.display = 'none';
                parentIdSelect.removeAttribute('required');
                photoGroup.style.display = 'block';
            } else {
                // âœ… It's a subcategory
                parentCategoryGroup.style.display = 'block';
                parentIdSelect.setAttribute('required', 'required');
                photoGroup.style.display = 'none';
            }
        }

        toggleParentField();
        isParentCheckbox.addEventListener('change', toggleParentField);
    });
</script>

{% endblock %}
